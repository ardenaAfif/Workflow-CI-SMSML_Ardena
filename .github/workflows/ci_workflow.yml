name: CI Model Retraining and Docker Build (Pip)

on:
  push:
    branches:
      - main
    paths:
      - 'MLProject/**' 
      - '.github/workflows/ci_workflow.yml'
  workflow_dispatch:

jobs:
  # Job pertama: Melatih ulang model menggunakan MLflow Project
  retrain_and_log_model:
    name: Retrain Model with MLflow Project (Pip)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./MLProject 

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        id: setup_python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9' 

      - name: Install Dependencies (pip)
        run: |
          python -m pip install --upgrade pip
          # Instal dari requirements.txt yang ada di dalam working-directory (MLProject/)
          pip install -r requirements.txt 
          echo "Dependensi berhasil diinstal dari requirements.txt"

            - name: Run MLflow Project
        env:
          DAGSHUB_USER_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
          DAGSHUB_USERNAME: ${{ secrets.DAGSHUB_USERNAME_OVERRIDE }}
          DAGSHUB_REPO: ${{ secrets.DAGSHUB_REPO_OVERRIDE }}
        run: |
          echo "Current directory: $(pwd)"
          echo "Python version: $(python --version)"
          echo "MLflow version: $(mlflow --version)"
          echo "Listing files in current directory (MLProject/): $(ls -la)"
          echo "Running MLflow Project..."

          dagshub_user=${DAGSHUB_USERNAME:-ardenaAfif}
          dagshub_repo=${DAGSHUB_REPO:-SMSML_Ardena-Afif}

          mlflow run . \
            -P tracking_mode="dagshub" \
            -P experiment_name="Shopping_Trends_CI_Pip_Actions" \
            -P dagshub_user="$dagshub_user" \
            -P dagshub_repo="$dagshub_repo"


  # Job kedua: Membangun dan mendorong image Docker
  build_and_push_docker_image:
    name: Build and Push Docker Image (Pip)
    runs-on: ubuntu-latest
    needs: retrain_and_log_model
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        id: docker_build 
        uses: docker/build-push-action@v5
        with:
          context: ./MLProject 
          file: ./MLProject/Dockerfile 
          push: true 
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/shopping-trends-model-pip:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/shopping-trends-model-pip:${{ github.sha }}
      
      - name: Print image digest
        run: echo "Image digest: ${{ steps.docker_build.outputs.digest }}"
