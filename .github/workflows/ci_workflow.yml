name: CI Workflow for Shopping Trends

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  DOCKER_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  DOCKER_PASSWORD: ${{ secrets.DOCKERHUB_TOKEN }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:

    - name: ⬇️ Checkout Repository
      uses: actions/checkout@v3

    - name: 🐍 Set up Python 3.12.7
      uses: actions/setup-python@v4
      with:
        python-version: '3.12.7'

    - name: 🔍 Check Python & Pip Version
      run: |
        python --version
        pip --version

    - name: 📦 Install Dependencies
      run: |
        pip install -r ./MLProject/requirements.txt
        pip install mlflow dagshub scikit-learn pandas matplotlib seaborn

    - name: 🚀 Run MLflow Project
      run: |
        mlflow run ./MLProject \
          --env-manager=local \
          -P data_file=processed_shopping_trends.csv \
          -P experiment_name=Shopping_Trends_CI \
          -P n_estimators=100 \
          -P max_depth=None \
          -P min_samples_split=2 \
          -P min_samples_leaf=1 \
          -P class_weight=None \
          -P run_name=RF_CI_Classifier_Run

    - name: 🆔 Get Latest MLflow run_id
      id: get_run_id
      run: |
        echo "Getting latest run ID..."
        RUN_ID=$(mlflow runs list --experiment-name Shopping_Trends_CI_Pip --order-by attributes.start_time desc | awk 'NR==2 {print $1}')
        echo "Latest run ID is: $RUN_ID"
        echo "RUN_ID=$RUN_ID" >> $GITHUB_ENV

    - name: 📤 Upload Artifacts to GitHub
      uses: actions/upload-artifact@v4
      with:
        name: mlflow-artifacts
        path: |
          ./MLProject/mlruns/${{ env.RUN_ID}}
          artifacts_temp/

    - name: 🛠️ Build Docker Image using MLflow
      run: |
        mlflow models build-docker -m "runs:/${{ env.RUN_ID }}/model" -n shopping-trends-ci:latest

    - name: 🔐 Log in to Docker Hub
      run: echo "${{ env.DOCKER_PASSWORD }}" | docker login -u "${{ env.DOCKER_USERNAME }}" --password-stdin

    - name: 🏷️ Tag Docker Image
      run: |
        docker tag shopping-trends-ci:latest ${{ env.DOCKER_USERNAME }}/shopping-trends-ci:latest

    - name: 🚢 Push Docker Image to Docker Hub
      run: |
        docker push ${{ env.DOCKER_USERNAME }}/shopping-trends-ci:latest

    - name: 📤 Post Log in to Docker Hub (Logout)
      if: always()
      run: docker logout

    - name: 🧹 Post Set up Python
      if: always()
      run: echo "Post Python setup completed."

    - name: 🧹 Post Checkout
      if: always()
      run: echo "Post checkout step completed."

    - name: ✅ Complete Job
      if: always()
      run: echo "CI Workflow for ML and Docker finished successfully."